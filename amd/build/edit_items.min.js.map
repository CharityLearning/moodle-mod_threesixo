{"version":3,"sources":["../src/edit_items.js"],"names":["define","$","Templates","Notification","Ajax","Str","Bank","ACTIONS","DELETE","MOVE_UP","MOVE_DOWN","SELECTORS","ITEM_LIST","ITEM_ROW","threesixtyId","editItems","threesixtyid","registerEvents","refreshItemList","promises","call","methodname","args","when","then","response","context","items","itemCount","length","each","key","value","item","deletebutton","moveupbutton","movedownbutton","type","typetext","position","push","allitems","render","done","compiledSource","js","replaceWith","runTemplateJS","fail","exception","callItemAction","action","itemId","itemid","result","warnings","join","Error","prototype","click","e","preventDefault","init","data","root","document","querySelector","rows","querySelectorAll","forEach","row","addEventListener","handleDrag","handleDragOver","handleDrop","dragSrcEl","target","dataTransfer","effectAllowed","setData","outerHTML","stopPropagation","dropTarget","closest","sourceItemID","getAttribute","sourcePosition","parseInt","targetPosition","moveTo","parentNode","removeChild","templateElement","createElement","innerHTML","getData","trim","droppedElement","content","firstChild","setAttribute","insertAdjacentElement","itemPosition","dropEffect"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD code for the frequently used comments chooser for the marking guide grading form.\n *\n * @module     mod_threesixo/edit_items\n * @class      edit_items\n * @package    core\n * @copyright  2016 Jun Pataleta <jun@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/templates',\n    'core/notification',\n    'core/ajax',\n    'core/str',\n    'mod_threesixo/question_bank'\n], function($, Templates, Notification, Ajax, Str, Bank) {\n\n    /**\n     * List of action selectors.\n     *\n     * @type {{DELETE: string, MOVE_UP: string, MOVE_DOWN: string}}\n     */\n    var ACTIONS = {\n        DELETE: '[data-action=\"delete-item\"]',\n        MOVE_UP: '[data-action=\"move-item-up\"]',\n        MOVE_DOWN: '[data-action=\"move-item-down\"]'\n    };\n\n    /**\n     * List of selectors.\n     *\n     * @type {{ITEM_LIST: string, ITEM_ROW: string}}\n     */\n    var SELECTORS = {\n        ITEM_LIST: '[data-region=\"itemlist\"]',\n        ITEM_ROW: '[data-region=\"itemrow\"]'\n    };\n\n    var threesixtyId;\n    var editItems = function(threesixtyid) {\n        threesixtyId = threesixtyid;\n        this.registerEvents();\n    };\n\n    editItems.refreshItemList = function() {\n        var promises = Ajax.call([\n            {\n                methodname: 'mod_threesixo_get_items',\n                args: {\n                    threesixtyid: threesixtyId\n                }\n            }\n        ]);\n        $.when(promises[0]).then(function(response) {\n            var context = {\n                threesixtyid: threesixtyId\n            };\n\n            var items = [];\n            var itemCount = response.items.length;\n            $.each(response.items, function(key, value) {\n                var item = value;\n                item.deletebutton = true;\n                item.moveupbutton = false;\n                item.movedownbutton = false;\n                item.type = value.typetext;\n                if (itemCount > 1) {\n                    item.position = value.position;\n                    if (value.position === 1) {\n                        item.movedownbutton = true;\n                    } else if (value.position === itemCount) {\n                        item.moveupbutton = true;\n                    } else if (value.position > 1 && value.position < itemCount) {\n                        item.moveupbutton = true;\n                        item.movedownbutton = true;\n                    }\n                }\n                items.push(item);\n            });\n            context.allitems = items;\n\n            return Templates.render('mod_threesixo/list_360_items', context);\n\n        }).done(function(compiledSource, js) {\n            $('[data-region=\"itemlist\"]').replaceWith(compiledSource);\n            Templates.runTemplateJS(js);\n\n        }).fail(Notification.exception);\n    };\n\n    editItems.callItemAction = function(action, itemId) {\n        var promises = Ajax.call([\n            {\n                methodname: action,\n                args: {\n                    itemid: itemId\n                }\n            }\n        ]);\n        promises[0].done(function(response) {\n            if (response.result) {\n                editItems.refreshItemList();\n                return true;\n            }\n            var warnings = response.warnings.join($('<br/>'));\n            throw new Error(warnings);\n        }).fail(Notification.exception);\n    };\n\n    editItems.prototype.registerEvents = function() {\n        // Bind click event for the comments chooser button.\n        $(\"#btn-question-bank\").click(function(e) {\n            e.preventDefault();\n            Bank.init(threesixtyId);\n        });\n\n        $(ACTIONS.DELETE).click(function(e) {\n            e.preventDefault();\n\n            var itemId = $(this).data('itemid');\n            editItems.callItemAction('mod_threesixo_delete_item', itemId);\n        });\n\n        $(ACTIONS.MOVE_UP).click(function(e) {\n            e.preventDefault();\n\n            var itemId = $(this).data('itemid');\n            editItems.callItemAction('mod_threesixo_move_item_up', itemId);\n        });\n\n        $(ACTIONS.MOVE_DOWN).click(function(e) {\n            e.preventDefault();\n\n            var itemId = $(this).data('itemid');\n            editItems.callItemAction('mod_threesixo_move_item_down', itemId);\n        });\n\n        const root = document.querySelector(SELECTORS.ITEM_LIST);\n        const rows = root.querySelectorAll(SELECTORS.ITEM_ROW);\n        rows.forEach((row) => {\n            row.addEventListener('dragstart', handleDrag, false);\n            row.addEventListener('dragover', handleDragOver, false);\n            row.addEventListener('drop', handleDrop, false);\n        });\n\n    };\n\n    let dragSrcEl = null;\n\n    const handleDrag = (e) => {\n        dragSrcEl = e.target;\n\n        e.dataTransfer.effectAllowed = 'move';\n        e.dataTransfer.setData('text/html', dragSrcEl.outerHTML);\n    };\n\n    const handleDrop = (e) => {\n        if (e.stopPropagation) {\n            e.stopPropagation();\n        }\n        const dropTarget = e.target.closest(SELECTORS.ITEM_ROW);\n\n        // Don't do anything if dropping the same column we're dragging.\n        if (dragSrcEl !== undefined && dragSrcEl !== dropTarget) {\n            // Set the source column's HTML to the HTML of the column we dropped on.\n            const sourceItemID = dragSrcEl.getAttribute('data-itemid');\n            const sourcePosition = parseInt(dragSrcEl.getAttribute('data-position'));\n            let targetPosition = parseInt(dropTarget.getAttribute('data-position'));\n            let moveTo = 'beforebegin';\n            if (sourcePosition < targetPosition) {\n                moveTo = 'afterend';\n            }\n            dragSrcEl.parentNode.removeChild(dragSrcEl);\n\n            const templateElement = document.createElement('template');\n            templateElement.innerHTML = e.dataTransfer.getData('text/html').trim();\n            const droppedElement = templateElement.content.firstChild;\n            droppedElement.setAttribute('data-position', targetPosition);\n            dropTarget.insertAdjacentElement(moveTo, droppedElement);\n\n            const rows = dropTarget.parentNode.querySelectorAll(SELECTORS.ITEM_ROW);\n            rows.forEach((row) => {\n                let itemId = row.getAttribute('data-itemid');\n                let itemPosition = parseInt(row.getAttribute('data-position'));\n                if (itemId !== sourceItemID) {\n                    if (moveTo === 'beforebegin' && itemPosition >= targetPosition) {\n                        row.setAttribute('data-position', itemPosition + 1);\n                    } else if (moveTo === 'afterend' && itemPosition <= targetPosition) {\n                        row.setAttribute('data-position', itemPosition - 1);\n                    }\n                }\n            });\n        }\n\n        return false;\n    };\n\n    const handleDragOver = (e) => {\n        if (e.preventDefault) {\n            e.preventDefault();\n        }\n\n        e.dataTransfer.dropEffect = 'move';\n\n        return false;\n    };\n\n    return editItems;\n});\n"],"file":"edit_items.min.js"}