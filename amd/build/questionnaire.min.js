define("mod_threesixo/questionnaire",["exports","core/notification","core/ajax","core/str","core/modal_factory","core/modal_events","core/toast","core/pending"],(function(_exports,_notification,_ajax,_str,_modal_factory,_modal_events,_toast,_pending){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_ajax=_interopRequireDefault(_ajax),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_pending=_interopRequireDefault(_pending);var selectors_commentItem='textarea[data-region="comment-item"]',selectors_questionnaireTable='[data-region="questionnaire"]',selectors_ratingOption="input[type=radio]",selectors_questionItem='[data-region="question-item"]',responses=[];_exports.init=function(){var pending=new _pending.default("mod_threesixo/questionnaire-init");registerEvents();var questionItems=document.querySelectorAll(selectors_questionItem);questionItems.forEach((function(option){responses[option.dataset.itemid]=null}));var questionnaireTable=document.querySelector(selectors_questionnaireTable),fromUser=questionnaireTable.dataset.fromuserid,toUser=questionnaireTable.dataset.touserid,threesixtyId=questionnaireTable.dataset.threesixtyid;_ajax.default.call([{methodname:"mod_threesixo_get_responses",args:{threesixtyid:threesixtyId,fromuserid:fromUser,touserid:toUser}}])[0].then((function(result){return result.responses.forEach((function(response){responses[response.item]=response.value;var responseItemId=parseInt(response.item);questionItems.forEach((function(questionItem){if(parseInt(questionItem.getAttribute("data-itemid"))===responseItemId){var options=questionItem.querySelectorAll(selectors_ratingOption);if(options.length)options.forEach((function(option){option.value===response.value&&handleOptionActivation(option)}));else{var commentTextArea=questionItem.querySelector(selectors_commentItem);commentTextArea&&(commentTextArea.value=response.value)}}}))})),!0})).then(pending.resolve).catch(_notification.default.exception)};var fn,_ref,registerEvents=function(){document.addEventListener("change",(function(e){var ratingOption=e.target.closest(selectors_ratingOption);ratingOption&&ratingOption.checked&&handleOptionActivation(ratingOption)})),document.addEventListener("click",(function(e){var ratingOption=e.target.closest(selectors_ratingOption);if(ratingOption){var ratingOptionLabel=ratingOption.closest("label");ratingOptionLabel&&ratingOptionLabel.classList.add("focus")}})),document.addEventListener("blur",(function(e){var ratingOption=e.target.closest(selectors_ratingOption);if(ratingOption){var ratingOptionLabel=ratingOption.closest("label");ratingOptionLabel&&ratingOptionLabel.classList.remove("focus")}})),document.getElementById("save-feedback").addEventListener("click",(function(e){e.preventDefault(),saveResponses(!1)})),document.getElementById("submit-feedback").addEventListener("click",(function(e){e.preventDefault(),saveResponses(!0)}))},handleOptionActivation=function(ratingOption){var pending=new _pending.default("mod_threesixo:handleOptionActivation"),optionGroup=ratingOption.closest(selectors_questionItem),itemId=optionGroup.getAttribute("data-itemid");optionGroup.querySelectorAll(selectors_ratingOption).forEach((function(option){var optionLabel=option.nextElementSibling;optionLabel.classList.contains("btn-success")&&(optionLabel.classList.toggle("btn-success",!1),optionLabel.classList.toggle("btn-secondary",!0),option.checked=!1)}));var selectedLabel=ratingOption.nextElementSibling;selectedLabel.classList.remove("btn-secondary"),selectedLabel.classList.add("btn-success"),ratingOption.checked=!0,responses[itemId]=ratingOption.value,pending.resolve()},saveResponses=function(finalise){document.querySelectorAll(selectors_commentItem).forEach((function(comment){responses[comment.dataset.itemid]=comment.value.trim()}));var questionnaireTable=document.querySelector(selectors_questionnaireTable),toUser=parseInt(questionnaireTable.dataset.touserid),toUserFullname=questionnaireTable.dataset.tousername,threesixtyId=parseInt(questionnaireTable.dataset.threesixtyid);if(parseInt(questionnaireTable.dataset.anonymous)&&finalise){var messageStrings=[{key:"finaliseanonymousfeedback",component:"mod_threesixo"},{key:"confirmfinaliseanonymousfeedback",component:"mod_threesixo",param:{name:toUserFullname}}];(0,_str.get_strings)(messageStrings,"mod_threesixo").then((function(messages){return showConfirmationDialogue(messages[0],messages[1],threesixtyId,toUser,responses,finalise)})).catch(_notification.default.exception)}else submitResponses(threesixtyId,toUser,responses,finalise)},submitResponses=function(threesixtyId,toUser,responses,finalise){var pending=new _pending.default("mod_threesixo/submit-responses"),redirectUrl=null;_ajax.default.call([{methodname:"mod_threesixo_save_responses",args:{threesixtyid:threesixtyId,touserid:toUser,responses:responses,complete:finalise}}])[0].then((function(response){return window.console.log("RESPONSE SHOULD HAVE ARRIVED"),response.result?(redirectUrl=response.redirurl,(0,_str.get_string)("responsessaved","mod_threesixo")):(0,_str.get_string)("errorresponsesavefailed","mod_threesixo")})).then((function(message){return window.console.log("MESSAGE HERE!"),!!finalise||(0,_toast.add)(message,{})})).then((function(){if(pending.resolve(),finalise&&redirectUrl){var form=document.getElementById("questionnaire");document.getElementById("feedback-submitted").value=1,form.submit()}return!0})).catch(_notification.default.exception)},showConfirmationDialogue=(fn=regeneratorRuntime.mark((function _callee(title,confirmationMessage,threesixtyId,toUser,responses,finalise){var confirmButtonText,confirmModal;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,(0,_str.get_string)("finalise","mod_threesixo");case 2:return confirmButtonText=_context.sent,_context.next=5,_modal_factory.default.create({title:title,body:confirmationMessage,large:!0,type:_modal_factory.default.types.SAVE_CANCEL});case 5:(confirmModal=_context.sent).setSaveButtonText(confirmButtonText),confirmModal.show(),confirmModal.getRoot().on(_modal_events.default.hidden,(function(){confirmModal.setBody("")})),confirmModal.getRoot().on(_modal_events.default.save,(function(){submitResponses(threesixtyId,toUser,responses,finalise)}));case 10:case"end":return _context.stop()}}),_callee)})),_ref=function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))},function(_x,_x2,_x3,_x4,_x5,_x6){return _ref.apply(this,arguments)})}));

//# sourceMappingURL=questionnaire.min.js.map