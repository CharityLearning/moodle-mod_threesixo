/**
 * AMD code for the Question Bank.
 *
 * The question bank dialogue contains all the questions that can be added to the 360 feedback activity.
 * It also serves as the interface where questions can be added, edited, or even removed permanently from the question bank.
 *
 * @module     mod_threesixo/question_bank
 * @class      question_bank
 * @copyright  2016 Jun Pataleta <jun@moodle.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_threesixo/question_bank",["jquery","core/templates","core/notification","core/ajax","core/str","core/modal_factory","core/modal_events"],(function($,templates,notification,ajax,str,ModalFactory,ModalEvents){var selectedQuestionsOld,selectedQuestions,threeSixtyId,questionTypes,questionBankDialogue,inputDialogue,questions=[];function checkQuestions(questions){for(var i in questions){var question=questions[i];-1!==selectedQuestions.indexOf(questions[i].id)&&(question.checked=!0)}return questions}var displayInputDialogue=function(threesixtyId,questionId){str.get_string("addanewquestion","mod_threesixo").done((function(title){var data={threesixtyid:threesixtyId};if(void 0!==questionId)for(var i in data.questionid=questionId,questions){var question=questions[i];if(question.id===questionId){data.question=question.question,data.type=question.type;break}}data.questionTypes=function(selectedId){var questionTypeOptions=[];for(var key in questionTypes)if(questionTypes.hasOwnProperty(key)){var questionType={typeVal:key,typeName:questionTypes[key]};void 0!==selectedId&&key==selectedId&&(questionType.selected=!0),questionTypeOptions.push(questionType)}return questionTypeOptions}(data.type);var dialogueTitle,bodyTemplate,body=templates.render("mod_threesixo/item_edit",data);dialogueTitle=title,bodyTemplate=body,inputDialogue?(inputDialogue.setBody(bodyTemplate),inputDialogue.show()):ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:dialogueTitle,body:bodyTemplate,large:!0}).then((function(modal){(inputDialogue=modal).show(),modal.getRoot().on(ModalEvents.shown,(function(){$("#question-input").focus()})),modal.getRoot().on(ModalEvents.hidden,(function(){modal.setBody("")})),modal.getRoot().on(ModalEvents.save,(function(){var question=$("#question-input").val().trim();if(question){var data={question:question,type:$("#question-type-select").val(),threesixtyid:$("#threesixtyid").val()},method="mod_threesixo_add_question",questionId=$("#question-id").val();questionId&&(method="mod_threesixo_update_question",data.id=questionId),ajax.call([{methodname:method,args:data}])[0].done((function(){refreshQuestionsList()})).fail(notification.exception)}else str.get_string("requiredelement","form").done((function(errorMsg){var errorMessage=$("<div/>").append(errorMsg).attr("class","alert alert-error").attr("role","alert");$(".error-container").html(errorMessage)})).fail(notification.exception)}))})).catch(notification.exception)})).fail(notification.exception)};function refreshQuestionsList(){ajax.call([{methodname:"mod_threesixo_get_questions",args:{}}])[0].done((function(response){questions=response.questions;var data={pickerMode:threeSixtyId,questions:checkQuestions(questions)};templates.render("mod_threesixo/question_list",data).done((function(compiledSource){$("#questionListWrapper").html(compiledSource),bindItemActionEvents()})).fail(notification.exception)})).fail(notification.exception)}var bindItemActionEvents=function(){$(".question-checkbox").click((function(){var questionId=parseInt(this.getAttribute("data-questionid"));if($(this).is(":checked"))selectedQuestions.push(questionId);else{var index=selectedQuestions.indexOf(questionId);index>-1&&selectedQuestions.splice(index,1)}})),$(".edit-question-button").click((function(){var threesixtyId=$(this).data("threesixtyid"),questionId=$(this).data("questionid");displayInputDialogue(threesixtyId,questionId)})),$(".delete-question-button").click((function(){var deleteButton=$(this),threesixtyId=deleteButton.data("threesixtyid");!function(questionId,threesixtyId){str.get_string("deletequestion","mod_threesixo").done((function(title){ModalFactory.create({title:title,body:str.get_string("confirmquestiondeletion","mod_threesixo"),type:ModalFactory.types.SAVE_CANCEL}).then((function(modal){modal.getRoot().on(ModalEvents.save,(function(){ajax.call([{methodname:"mod_threesixo_delete_question",args:{id:questionId,threesixtyid:threesixtyId}}])[0].done((function(){refreshQuestionsList()})).fail(notification.exception)})),modal.show()})).catch(notification.exception)}))}(deleteButton.data("questionid"),threesixtyId)}))};function renderQuestionBank(){var context={pickerMode:threeSixtyId};ajax.call([{methodname:"mod_threesixo_get_questions",args:{}}])[0].done((function(response){questions=response.questions,context.questions=checkQuestions(questions);var questionBankTemplate=templates.render("mod_threesixo/question_bank",context);str.get_string("labelpickfromquestionbank","mod_threesixo").done((function(title){!function(title,questionBankTemplate){questionBankDialogue?(questionBankDialogue.setBody(questionBankTemplate),questionBankDialogue.show()):ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:questionBankTemplate,large:!0}).then((function(modal){var modalRoot=modal.getRoot();modalRoot.on(ModalEvents.hidden,(function(){modal.setBody("")})),modalRoot.on(ModalEvents.save,(function(){var changed=!1;if($.each(selectedQuestionsOld,(function(key,questionId){-1===selectedQuestions.indexOf(questionId)&&(changed=!0)})),changed||$.each(selectedQuestions,(function(key,questionId){-1===selectedQuestionsOld.indexOf(questionId)&&(changed=!0)})),changed){var data={threesixtyid:threeSixtyId,questionids:selectedQuestions};ajax.call([{methodname:"mod_threesixo_set_items",args:data}])[0].done((function(){require(["mod_threesixo/edit_items"],(function(items){items.refreshItemList()}))})).fail(notification.exception)}})),(questionBankDialogue=modal).show()})).catch(notification.exception)}(title,questionBankTemplate)})).fail(notification.exception)})).fail(notification.exception)}return{init:function(id){var methodCalls=[{methodname:"mod_threesixo_get_question_types",args:{}}];(threeSixtyId=id)&&methodCalls.push({methodname:"mod_threesixo_get_items",args:{threesixtyid:threeSixtyId}});var promises=ajax.call(methodCalls);promises[0].done((function(response){questionTypes=response.questiontypes,threeSixtyId?(selectedQuestions=[],selectedQuestionsOld=[],promises[1].done((function(response){var items=response.items;for(var i in items)items.hasOwnProperty(i)&&(selectedQuestions.push(items[i].questionid),selectedQuestionsOld.push(items[i].questionid));renderQuestionBank()})).fail(notification.exception)):renderQuestionBank()})).fail(notification.exception)},displayInputDialogue:displayInputDialogue,bindItemActionEvents:bindItemActionEvents}}));

//# sourceMappingURL=question_bank.min.js.map