define("mod_threesixo/question_bank",["exports","jquery","core/templates","core/notification","core/ajax","core/str","core/modal_factory","core/modal_events","core/pending"],(function(_exports,_jquery,templates,notification,ajax,_str,_modal_factory,_modal_events,_pending){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * AMD code for the Question Bank.
   *
   * The question bank dialogue contains all the questions that can be added to the 360 feedback activity.
   * It also serves as the interface where questions can be added, edited, or even removed permanently from the question bank.
   *
   * @module     mod_threesixo/question_bank
   * @class      question_bank
   * @copyright  2016 Jun Pataleta <jun@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),templates=_interopRequireWildcard(templates),notification=_interopRequireWildcard(notification),ajax=_interopRequireWildcard(ajax),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_pending=_interopRequireDefault(_pending);let selectedQuestionsOld,selectedQuestions,threeSixtyId,questionTypes,questionBankDialogue,inputDialogue,questions=[];function checkQuestions(questions){for(const i in questions){const question=questions[i];-1!==selectedQuestions.indexOf(questions[i].id)&&(question.checked=!0)}return questions}const displayInputDialogue=function(threesixtyId,questionId){(0,_str.get_string)("addanewquestion","mod_threesixo").done((function(title){const data={threesixtyid:threesixtyId};if(void 0!==questionId){data.questionid=questionId;for(const i in questions){const question=questions[i];if(question.id===questionId){data.question=question.question,data.type=question.type;break}}}data.questionTypes=function(selectedId){const questionTypeOptions=[];for(const key in questionTypes){if(!questionTypes.hasOwnProperty(key))continue;const questionType={typeVal:key,typeName:questionTypes[key]};void 0!==selectedId&&key==selectedId&&(questionType.selected=!0),questionTypeOptions.push(questionType)}return questionTypeOptions}(data.type);!function(dialogueTitle,bodyTemplate){const pendingPromise=new _pending.default("mod_threesixo/question_input");inputDialogue?(inputDialogue.setBody(bodyTemplate),inputDialogue.show(),pendingPromise.resolve()):_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:dialogueTitle,body:bodyTemplate,large:!0}).then((function(modal){inputDialogue=modal,inputDialogue.show(),modal.getRoot().on(_modal_events.default.shown,(function(){(0,_jquery.default)("#question-input").focus()})),modal.getRoot().on(_modal_events.default.hidden,(function(){modal.setBody("")})),modal.getRoot().on(_modal_events.default.save,(function(){const question=(0,_jquery.default)("#question-input").val().trim();if(!question)return void(0,_str.get_string)("requiredelement","form").done((function(errorMsg){const errorMessage=(0,_jquery.default)("<div/>").append(errorMsg).attr("class","alert alert-error").attr("role","alert");(0,_jquery.default)(".error-container").html(errorMessage)})).fail(notification.exception);const data={question:question,type:(0,_jquery.default)("#question-type-select").val(),threesixtyid:(0,_jquery.default)("#threesixtyid").val()};let method="mod_threesixo_add_question";const questionId=(0,_jquery.default)("#question-id").val();questionId&&(method="mod_threesixo_update_question",data.id=questionId),ajax.call([{methodname:method,args:data}])[0].done((function(){refreshQuestionsList()})).fail(notification.exception)}))})).then((()=>(pendingPromise.resolve(),null))).catch(notification.exception)}(title,templates.render("mod_threesixo/item_edit",data))})).fail(notification.exception)};const bindItemActionEvents=function(){(0,_jquery.default)(".question-checkbox").click((function(){const questionId=parseInt(this.getAttribute("data-questionid"));if((0,_jquery.default)(this).is(":checked"))selectedQuestions.push(questionId);else{const index=selectedQuestions.indexOf(questionId);index>-1&&selectedQuestions.splice(index,1)}})),(0,_jquery.default)(".edit-question-button").click((function(){const threesixtyId=(0,_jquery.default)(this).data("threesixtyid"),questionId=(0,_jquery.default)(this).data("questionid");displayInputDialogue(threesixtyId,questionId)})),(0,_jquery.default)(".delete-question-button").click((function(){const deleteButton=(0,_jquery.default)(this),threesixtyId=deleteButton.data("threesixtyid");!function(questionId,threesixtyId){(0,_str.get_string)("deletequestion","mod_threesixo").done((function(title){_modal_factory.default.create({title:title,body:(0,_str.get_string)("confirmquestiondeletion","mod_threesixo"),type:_modal_factory.default.types.SAVE_CANCEL}).then((function(modal){modal.getRoot().on(_modal_events.default.save,(function(){ajax.call([{methodname:"mod_threesixo_delete_question",args:{id:questionId,threesixtyid:threesixtyId}}])[0].done((function(){refreshQuestionsList()})).fail(notification.exception)})),modal.show()})).catch(notification.exception)}))}(deleteButton.data("questionid"),threesixtyId)}))};function refreshQuestionsList(){ajax.call([{methodname:"mod_threesixo_get_questions",args:{}}])[0].done((function(response){questions=response.questions;const data={pickerMode:threeSixtyId,questions:checkQuestions(questions)};templates.render("mod_threesixo/question_list",data).done((function(compiledSource){(0,_jquery.default)("#questionListWrapper").html(compiledSource),bindItemActionEvents()})).fail(notification.exception)})).fail(notification.exception)}function renderQuestionBank(){const context={pickerMode:threeSixtyId};ajax.call([{methodname:"mod_threesixo_get_questions",args:{}}])[0].done((function(response){questions=response.questions,context.questions=checkQuestions(questions);const questionBankTemplate=templates.render("mod_threesixo/question_bank",context);(0,_str.get_string)("labelpickfromquestionbank","mod_threesixo").done((function(title){!function(title,questionBankTemplate){const pendingPromise=new _pending.default("mod_threesixo/question_bank");questionBankDialogue?(questionBankDialogue.setBody(questionBankTemplate),questionBankDialogue.show(),pendingPromise.resolve()):_modal_factory.default.create({type:_modal_factory.default.types.SAVE_CANCEL,title:title,body:questionBankTemplate,large:!0}).then((function(modal){const modalRoot=modal.getRoot();modalRoot.on(_modal_events.default.hidden,(function(){modal.setBody("")})),modalRoot.on(_modal_events.default.save,(function(){let changed=!1;if(_jquery.default.each(selectedQuestionsOld,(function(key,questionId){-1===selectedQuestions.indexOf(questionId)&&(changed=!0)})),changed||_jquery.default.each(selectedQuestions,(function(key,questionId){-1===selectedQuestionsOld.indexOf(questionId)&&(changed=!0)})),changed){const data={threesixtyid:threeSixtyId,questionids:selectedQuestions};ajax.call([{methodname:"mod_threesixo_set_items",args:data}])[0].done((function(){require(["mod_threesixo/edit_items"],(function(items){items.refreshItemList()}))})).fail(notification.exception)}})),questionBankDialogue=modal,questionBankDialogue.show()})).then((()=>(pendingPromise.resolve(),null))).catch(notification.exception)}(title,questionBankTemplate)})).fail(notification.exception)})).fail(notification.exception)}var _default={init:function(id){threeSixtyId=id;const methodCalls=[{methodname:"mod_threesixo_get_question_types",args:{}}];threeSixtyId&&methodCalls.push({methodname:"mod_threesixo_get_items",args:{threesixtyid:threeSixtyId}});const promises=ajax.call(methodCalls);promises[0].done((function(response){questionTypes=response.questiontypes,threeSixtyId?(selectedQuestions=[],selectedQuestionsOld=[],promises[1].done((function(response){const items=response.items;for(const i in items)items.hasOwnProperty(i)&&(selectedQuestions.push(items[i].questionid),selectedQuestionsOld.push(items[i].questionid));renderQuestionBank()})).fail(notification.exception)):renderQuestionBank()})).fail(notification.exception)},displayInputDialogue:displayInputDialogue,bindItemActionEvents:bindItemActionEvents};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=question_bank.min.js.map